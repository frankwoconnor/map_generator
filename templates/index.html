<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Map Art Generator</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
</head>
<body>
    <div class="container">
        <header class="page-header">
            <h1>üó∫Ô∏è Map Art Generator</h1>
        </header>

        {% if error_message %}
        <div class="alert alert-error">
            <strong>Error:</strong> {{ error_message }}
        </div>
        {% endif %}

        {% if warning_messages %}
        <div class="alerts">
            {% for category, message in warning_messages %}
            <div class="alert alert-{{ category }}">{{ message }}</div>
            {% endfor %}
        </div>
        {% endif %}

        <form id="map-form" method="POST">
            <!-- Presets Section -->
            <details class="section" open>
                <summary>
                    <span class="section-icon">üíæ</span>
                    <span class="section-title">Presets</span>
                </summary>
                <div class="section-content">
                    <div class="form-row">
                        <div class="form-field">
                            <label for="preset-select">Load Preset</label>
                            <div class="input-group">
                                <select id="preset-select">
                                    <option value="">-- Select a preset --</option>
                                    {% for preset in presets %}
                                    <option value="{{ preset }}">{{ preset }}</option>
                                    {% endfor %}
                                </select>
                                <button type="button" class="btn btn-secondary btn-sm" id="load-preset-btn">Load</button>
                                <button type="button" class="btn btn-danger btn-sm" id="delete-preset-btn">Delete</button>
                            </div>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-field">
                            <label for="new-preset-name">Save as New Preset</label>
                            <div class="input-group">
                                <input type="text" id="new-preset-name" placeholder="Enter preset name">
                                <button type="button" class="btn btn-primary btn-sm" id="save-preset-btn">Save</button>
                            </div>
                        </div>
                    </div>
                </div>
            </details>
            <div class="action-bar">
                <button type="submit" name="action" value="generate" class="btn btn-primary">üöÄ Generate Map</button>
                <div class="status-indicator">Ready</div>
            </div>

            <!-- Settings Section -->
            <details class="section" open>
                <summary>
                    <span class="section-icon">‚öôÔ∏è</span>
                    <span class="section-title">Settings</span>
                    <span class="badge badge-required">Required</span>
                </summary>
                <div class="section-content">
                    <h4>Location</h4>
                    <div class="form-row">
                        <div class="form-field">
                            <label>Data Source</label>
                            <div class="radio-group">
                                <label class="radio-label">
                                    <input type="radio" id="data_remote" name="location_data_source" value="remote" {% if style.location.data_source != 'local' %}checked{% endif %}>
                                    Remote (OSM)
                                </label>
                                <label class="radio-label">
                                    <input type="radio" id="data_local" name="location_data_source" value="local" {% if style.location.data_source == 'local' %}checked{% endif %}>
                                    Local PBF
                                </label>
                            </div>
                        </div>
                    </div>

                    <div class="form-row">
                        {% set coords = style.location.query.replace(',', ' ').split() if style.location.query else [] %}
                        <div class="form-field">
                            <label for="location_latitude">Latitude</label>
                            <input type="number" id="location_latitude" name="location_latitude"
                                   value="{{ coords[0] if coords|length > 0 else '' }}"
                                   placeholder="51.8944" step="0.0001">
                        </div>
                        <div class="form-field">
                            <label for="location_longitude">Longitude</label>
                            <input type="number" id="location_longitude" name="location_longitude"
                                   value="{{ coords[1] if coords|length > 1 else '' }}"
                                   placeholder="-8.4827" step="0.0001">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-field">
                            <label for="location_distance">Distance (meters)</label>
                            <input type="number" id="location_distance" name="location_distance"
                                   value="{{ style.location.distance or '' }}"
                                   placeholder="100-20000" min="100" max="20000" step="100">
                        </div>
                    </div>

                    <div class="form-row pbf-only">
                        <div class="form-field">
                            <label for="location_pbf_folder">PBF Folder</label>
                            <div class="input-group">
                                <input type="text" id="location_pbf_folder" name="location_pbf_folder"
                                       value="{{ style.location.pbf_folder or '../osm-data/' }}"
                                       placeholder="../osm-data/">
                                <button type="button" class="btn btn-secondary btn-sm" id="scan_pbf_folder_btn">Scan</button>
                            </div>
                            <div id="pbf_scan_status" class="field-hint"></div>
                        </div>
                    </div>

                    <div class="form-row pbf-only">
                        <div class="form-field">
                            <label for="location_pbf_file_selection">PBF File</label>
                            <select id="location_pbf_file_selection" name="location_pbf_file_selection">
                                <option value="">-- Select a file --</option>
                                {% for file in pbf_files %}
                                <option value="{{ file.path }}" {% if style.location.pbf_path == file.path %}selected{% endif %}>
                                    {{ file.name }}
                                </option>
                                {% endfor %}
                                <option value="manual">-- Enter path manually --</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-row pbf-manual" style="display: none;">
                        <div class="form-field">
                            <label for="location_pbf_path">Manual PBF Path</label>
                            <input type="text" id="location_pbf_path" name="location_pbf_path"
                                   value="{{ style.location.pbf_path or '' }}"
                                   placeholder="/path/to/your.osm.pbf">
                        </div>
                    </div>

                    <h4 style="margin-top: var(--space-xl);">Output</h4>
                    <div class="form-row">
                        <div class="form-field">
                            <label for="filename_prefix">Filename Prefix</label>
                            <input type="text" id="filename_prefix" name="filename_prefix"
                                   value="{{ style.output.filename_prefix }}" placeholder="map">
                        </div>
                        <div class="form-field">
                            <label>
                                <input type="checkbox" name="separate_layers" {% if style.output.separate_layers %}checked{% endif %}>
                                Separate Layers
                            </label>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-field">
                            <label>Figure Size (inches)</label>
                            <div class="input-pair">
                                <input type="number" name="figure_size_width" value="{{ style.output.figure_size[0] }}"
                                       placeholder="Width" step="0.1">
                                <span>√ó</span>
                                <input type="number" name="figure_size_height" value="{{ style.output.figure_size[1] }}"
                                       placeholder="Height" step="0.1">
                            </div>
                        </div>
                        <div class="form-field">
                            <label for="figure_dpi">DPI</label>
                            <input type="number" id="figure_dpi" name="figure_dpi"
                                   value="{{ style.output.figure_dpi }}" placeholder="100">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-field">
                            <label for="background_color">Background Color</label>
                            <input type="color" id="background_color" name="background_color"
                                   value="{{ style.output.background_color }}">
                        </div>
                        <div class="form-field">
                            <label>
                                <input type="checkbox" name="transparent_background"
                                       {% if style.output.transparent_background %}checked{% endif %}>
                                Transparent Background
                            </label>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-field">
                            <label for="margin">Margin</label>
                            <input type="number" id="margin" name="margin" step="0.01"
                                   value="{{ style.output.margin }}" placeholder="0.05">
                        </div>
                        <div class="form-field">
                            <label>
                                <input type="checkbox" name="enable_debug_legends"
                                       {% if style.output.get('enable_debug_legends', False) %}checked{% endif %}>
                                Generate Debug Legends
                            </label>
                        </div>
                    </div>
                </div>
            </details>

            <!-- Layers Section -->
            <details class="section" open>
                <summary>
                    <span class="section-icon">üóÇÔ∏è</span>
                    <span class="section-title">Map Layers</span>
                </summary>
                <div class="section-content">
                    {% for layer_name, layer_config in style.layers.items() %}
                    <details class="layer-section">
                        <summary class="layer-header">
                            <input type="checkbox" id="{{ layer_name }}_enabled" name="{{ layer_name }}_enabled"
                                   {% if layer_config.enabled %}checked{% endif %} onclick="event.stopPropagation()">
                            <span class="layer-name">{{ layer_name | capitalize }}</span>
                        </summary>
                        <div class="layer-content">
                            <!-- Common Settings -->
                            <div class="form-row">
                                {% if layer_name != 'streets' %}
                                <div class="form-field">
                                    <label for="{{ layer_name }}_facecolor">Fill Color</label>
                                    <input type="color" id="{{ layer_name }}_facecolor" name="{{ layer_name }}_facecolor"
                                           value="{{ layer_config.facecolor }}">
                                </div>
                                {% endif %}
                                <div class="form-field">
                                    <label for="{{ layer_name }}_edgecolor">Line Color</label>
                                    <input type="color" id="{{ layer_name }}_edgecolor" name="{{ layer_name }}_edgecolor"
                                           value="{{ layer_config.edgecolor }}">
                                </div>
                                <div class="form-field">
                                    <label for="{{ layer_name }}_linewidth">Line Width</label>
                                    <input type="number" id="{{ layer_name }}_linewidth" name="{{ layer_name }}_linewidth"
                                           value="{{ layer_config.linewidth }}" step="0.1" min="0">
                                </div>
                            </div>

                            <div class="form-row">
                                <div class="form-field">
                                    <label for="{{ layer_name }}_alpha">Opacity</label>
                                    <input type="range" id="{{ layer_name }}_alpha" name="{{ layer_name }}_alpha"
                                           value="{{ layer_config.alpha }}" min="0" max="1" step="0.01">
                                    <output>{{ layer_config.alpha }}</output>
                                </div>
                                <div class="form-field">
                                    <label for="{{ layer_name }}_zorder">Z-Order</label>
                                    <input type="number" id="{{ layer_name }}_zorder" name="{{ layer_name }}_zorder"
                                           value="{{ layer_config.zorder }}" min="0">
                                </div>
                            </div>

                            <!-- Tag Filters -->
                            {% if layer_config.get('tag_configs') %}
                            <div class="tag-filters">
                                <h4>OSM Tag Filters</h4>
                                {% for tag_key, tag_config in layer_config.tag_configs.items() %}
                                <details class="filter-group">
                                    <summary>{{ tag_config['description'] }}
                                        <span class="count">({{ tag_config['values']|length }} options)</span>
                                    </summary>
                                    <div class="checkbox-grid">
                                        {% set current_filters = layer_config.get('filters', {}).get(tag_key, []) %}
                                        {% for value, label in tag_config['values'].items() %}
                                        <label class="checkbox-label">
                                            <input type="checkbox"
                                                   name="{{ layer_name }}_tag_{{ tag_key }}_{{ value }}"
                                                   {% if value in current_filters or (not current_filters and value in tag_config['default']) %}checked{% endif %}>
                                            {{ value }}
                                        </label>
                                        {% endfor %}
                                    </div>
                                </details>
                                {% endfor %}
                            </div>
                            {% endif %}

                            <!-- Buildings Special Settings -->
                            {% if layer_name == 'buildings' %}
                            <div class="buildings-styling">
                                <h4>Building Colors</h4>
                                <div class="form-field">
                                    <label for="building_styling_mode">Color Mode</label>
                                    <select id="building_styling_mode" name="building_styling_mode">
                                        {% set mode = style.layers.buildings.auto_style_mode if style.layers.buildings.auto_style_mode is not none else 'manual' %}
                                        <option value="manual" {% if mode == 'manual' %}selected{% endif %}>Single Color</option>
                                        <option value="auto_distance" {% if mode == 'auto_distance' %}selected{% endif %}>Gradient by Distance</option>
                                        <option value="auto_size" {% if mode == 'auto_size' %}selected{% endif %}>Gradient by Size</option>
                                        <option value="manual_floorsize" {% if mode == 'manual_floorsize' %}selected{% endif %}>Size Categories</option>
                                    </select>
                                </div>

                                <div id="manual-color-section" class="color-mode-section">
                                    <div class="form-field">
                                        <label for="buildings_manual_color_facecolor">Building Color</label>
                                        <input type="color" id="buildings_manual_color_facecolor" name="buildings_manual_color_facecolor"
                                               value="{{ style.layers.buildings.manual_color_settings.facecolor if style.layers.buildings.manual_color_settings.facecolor is not none else '#000000' }}">
                                    </div>
                                </div>

                                <div id="auto-distance-section" class="color-mode-section">
                                    <div class="form-field">
                                        <label for="auto_distance_palette">Color Palette</label>
                                        <select id="auto_distance_palette" name="auto_distance_palette">
                                            <option value="">-- Select Palette --</option>
                                        </select>
                                        <div class="palette-preview" id="auto_distance_palette_preview"></div>
                                    </div>
                                </div>

                                <div id="auto-size-section" class="color-mode-section">
                                    <div class="form-field">
                                        <label for="auto_size_palette">Color Palette</label>
                                        <select id="auto_size_palette" name="auto_size_palette">
                                            <option value="">-- Select Palette --</option>
                                        </select>
                                        <div class="palette-preview" id="auto_size_palette_preview"></div>
                                    </div>
                                </div>

                                <div id="manual-floorsize-section" class="color-mode-section">
                                    <button type="button" class="btn btn-secondary btn-sm" id="addCategoryBtn">+ Add Category</button>
                                    <div id="categories-list"></div>
                                </div>
                            </div>
                            {% endif %}

                            <!-- Advanced Settings (collapsed by default) -->
                            <details class="advanced-settings">
                                <summary>Advanced Settings</summary>
                                <div class="form-row">
                                    <div class="form-field">
                                        <label for="{{ layer_name }}_simplify_tolerance">Simplify Tolerance</label>
                                        <input type="number" id="{{ layer_name }}_simplify_tolerance" name="{{ layer_name }}_simplify_tolerance"
                                               value="{{ layer_config.simplify_tolerance }}" step="0.0000001" min="0">
                                    </div>
                                    <div class="form-field">
                                        <label for="{{ layer_name }}_min_size_threshold">Min Size (m¬≤)</label>
                                        <input type="number" id="{{ layer_name }}_min_size_threshold" name="{{ layer_name }}_min_size_threshold"
                                               value="{{ layer_config.min_size_threshold }}" step="0.0000001" min="0">
                                    </div>
                                    <div class="form-field">
                                        <label for="{{ layer_name }}_hatch">Hatch Pattern</label>
                                        <select id="{{ layer_name }}_hatch" name="{{ layer_name }}_hatch">
                                            <option value="null" {% if layer_config.hatch is none %}selected{% endif %}>None</option>
                                            <option value="/" {% if layer_config.hatch == '/' %}selected{% endif %}>/</option>
                                            <option value="-" {% if layer_config.hatch == '-' %}selected{% endif %}>-</option>
                                            <option value="+" {% if layer_config.hatch == '+' %}selected{% endif %}>+</option>
                                            <option value="x" {% if layer_config.hatch == 'x' %}selected{% endif %}>x</option>
                                        </select>
                                    </div>
                                </div>
                            </details>
                        </div>
                    </details>
                    {% endfor %}
                </div>
            </details>
        </form>

        <!-- Hidden data for JS -->
        <script type="application/json" id="initial-data">
        {
            "palettes": {{ palettes | default({}) | tojson | safe }},
            "buildingCategories": {{ style.layers.buildings.size_categories | default([]) | tojson | safe }},
            "buildingMode": {{ style.layers.buildings.auto_style_mode | default('manual') | tojson | safe }},
            "autoSizePalette": {{ style.layers.buildings.auto_size_palette | default('') | tojson | safe }},
            "autoDistancePalette": {{ style.layers.buildings.auto_distance_palette | default('') | tojson | safe }}
        }
        </script>
    </div>

    <script src="{{ url_for('static', filename='app.js') }}"></script>
</body>
</html>
